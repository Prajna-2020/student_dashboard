{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>AJIET Faculty Portal</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="{% static 'css/themify-icons.css' %}" />
    <link rel="stylesheet" href="{% static 'css/vendor.bundle.base.css' %}" />
    <!-- inject:css -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <!-- endinject -->
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %} " />

    <!-- Custom CSS -->
    <style>
      body {
        font-family: "Nunito", sans-serif;
        background-color: #f8f9fa;
      }
      .navbar {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      }
      .sidebar {
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      .sidebar .nav-item .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 1rem;
      }
      .sidebar .nav-item .nav-link:hover {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
      }
      .sidebar .nav-item .nav-link i {
        margin-right: 0.5rem;
      }
      .sidebar .nav-item.active .nav-link {
        color: #fff;
        font-weight: 700;
      }
      .content-wrapper {
        padding: 1.5rem;
      }
      .card {
        border: none;
        border-radius: 0.35rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
      }
      .dashboard-card {
        transition: all 0.3s;
      }
      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }
    </style>

    {% block extra_css %}{% endblock %}
  </head>

  <body>
    <div class="container-scroller">
      <!-- Top Navbar -->
      <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
        <div
          class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center"
        >
          <a class="navbar-brand brand-logo mr-5" href="{% url 'home' %}">
            <img
              src="{% static 'images/ajiet_logo.png' %}"
              style="width: 150px; height: auto"
              alt="logo"
            />
          </a>
        </div>
        <div
          class="navbar-menu-wrapper d-flex align-items-center justify-content-end"
        >
          <button
            class="navbar-toggler navbar-toggler align-self-center"
            type="button"
            data-toggle="minimize"
          >
            <span class="ti-view-list"></span>
          </button>
          <ul class="navbar-nav navbar-nav-right">
            <li class="nav-item dropdown mr-1">
              <div
                class="dropdown-menu dropdown-menu-right navbar-dropdown"
                aria-labelledby="messageDropdown"
              >
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <img
                      src="{% static 'images/face10.jpg' %}"
                      alt="image"
                      class="profile-pic"
                    />
                  </div>
                </a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link count-indicator dropdown-toggle"
                id="notificationDropdown"
                href="#"
                data-toggle="dropdown"
              >
                <i class="ti-bell mx-0"></i>
                <span class="count"></span>
              </a>
              <div
                class="dropdown-menu dropdown-menu-right navbar-dropdown"
                aria-labelledby="notificationDropdown"
              >
                <p class="mb-0 font-weight-normal float-left dropdown-header">
                  Notifications
                </p>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <div class="item-icon bg-success">
                      <i class="ti-info-alt mx-0"></i>
                    </div>
                  </div>
                  <div class="item-content">
                    <h6 class="font-weight-normal">Application Error</h6>
                    <p class="font-weight-light small-text mb-0 text-muted">
                      Just now
                    </p>
                  </div>
                </a>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <div class="item-icon bg-warning">
                      <i class="ti-settings mx-0"></i>
                    </div>
                  </div>
                  <div class="item-content">
                    <h6 class="font-weight-normal">Settings</h6>
                    <p class="font-weight-light small-text mb-0 text-muted">
                      Private message
                    </p>
                  </div>
                </a>
                <a class="dropdown-item">
                  <div class="item-thumbnail">
                    <div class="item-icon bg-info">
                      <i class="ti-user mx-0"></i>
                    </div>
                  </div>
                  <div class="item-content">
                    <h6 class="font-weight-normal">New user registration</h6>
                    <p class="font-weight-light small-text mb-0 text-muted">
                      2 days ago
                    </p>
                  </div>
                </a>
              </div>
            </li>
            <li class="nav-item nav-profile dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-toggle="dropdown"
                id="profileDropdown"
              >
                <span class="mr-2 d-none d-lg-inline text-gray-600"
                  >{{ request.user.email }}</span
                >
                {% if request.user.faculty.profile_picture %}
                <img
                  src="{{ request.user.faculty.profile_picture.url }}"
                  alt="Profile"
                  class="rounded-circle"
                  width="32"
                />
                {% else %}
                <i class="ti-user"></i>
                {% endif %}
              </a>
              <div
                class="dropdown-menu dropdown-menu-right navbar-dropdown"
                aria-labelledby="profileDropdown"
              >
                <a class="dropdown-item" href="/profile/">
                  <i class="ti-user text-primary"></i> Profile
                </a>
                <a class="dropdown-item" href="/signout/">
                  <i class="ti-power-off text-primary"></i> Logout
                </a>
                <a
                  class="dropdown-item"
                  href="{% url 'faculty_change_password' %}"
                >
                  <i class="ti-settings text-primary"></i>
                  Change Password
                </a>
              </div>
            </li>
          </ul>
          <button
            class="navbar-toggler navbar-toggler-right d-lg-none align-self-center"
            type="button"
            data-toggle="offcanvas"
          >
            <span class="ti-view-list"></span>
          </button>
        </div>
      </nav>

      <!-- Sidebar -->
      <div class="container-fluid page-body-wrapper">
        <nav class="sidebar sidebar-offcanvas" id="sidebar">
          <ul class="nav">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'faculty_dashboard' %}">
                <i class="ti-shield menu-icon"></i>
                <span class="menu-title">Dashboard</span>
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/fac_course/">
                <i class="ti-book menu-icon"></i>
                <span class="menu-title">View Courses</span>
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'faculty_list_students' %}">
                <i class="ti-book menu-icon"></i>
                <span class="menu-title">Students</span>
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'home' %}">
                <i class="ti-book menu-icon"></i>
                <span class="menu-title">View Documentation</span>
              </a>
            </li>
          </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-panel">
            <div class="content-wrapper">
              <div class="row">
                <div class="col-md-12 grid-margin stretch-card">
                  <div class="card">
                    <div class="card-body">
                      <h4 class="card-title">Students in {{ course.course_name }} ({{ course.course_code }})</h4>
                      <div class="d-flex justify-content-between mb-4">
                        <a href="{% url 'fac_course' %}" class="btn btn-secondary">
                          Back to Courses
                        </a>
                      </div>
                      
                      <div class="table-responsive">
                        <table class="table table-hover" id="studentsTable">
                          <thead>
                            <tr>
                              <th>USN</th>
                              <th>Name</th>
                              <th>Department</th>
                              <th>Semester</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for student in students %}
                            <tr>
                              <td>{{ student.usn }}</td>
                              <td>{{ student.first_name }} {{ student.last_name }}</td>
                              <td>{{ student.department.department_name }}</td>
                              <td>{{ student.current_semester }}</td>
                              <td>
                                <button class="btn btn-sm btn-primary edit-results-btn" 
                                        data-student-id="{{ student.student_id }}"
                                        data-course-id="{{ course.course_id }}">
                                  Edit Results
                                </button>
                              </td>
                            </tr>
                            {% empty %}
                            <tr>
                              <td colspan="5" class="text-center">No students enrolled in this course</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
      
          <!-- Results Modal -->
          <div class="modal fade" id="resultsModal" tabindex="-1" role="dialog" aria-labelledby="resultsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="resultsModalLabel">Edit Student Results</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form id="resultsForm">
                    {% csrf_token %}
                    <input type="hidden" id="studentId" name="student_id">
                    <input type="hidden" id="courseId" name="course_id">
                    
                    <div class="row">
                      <!-- Internals -->
                      <div class="col-md-6">
                        <h6>Internals (Max: {{ internal_max|floatformat:2 }})</h6>
                        {% for i in "x"|rjust:course.internal_count %}
                        <div class="form-group">
                          <label>Internal {{ forloop.counter }}</label>
                          <input type="number" step="0.01" class="form-control internal-mark" 
                                 name="internal_{{ forloop.counter }}" 
                                 max="{{ internal_max|floatformat:2 }}">
                        </div>
                        {% endfor %}
                      </div>
                      
                      <!-- Assignments -->
                      <div class="col-md-6">
                        <h6>Assignments (Max: {{ assignment_max|floatformat:2 }})</h6>
                        {% for i in "x"|rjust:course.assignment_count %}
                        <div class="form-group">
                          <label>Assignment {{ forloop.counter }}</label>
                          <input type="number" step="0.01" class="form-control assignment-mark" 
                                 name="assignment_{{ forloop.counter }}" 
                                 max="{{ assignment_max|floatformat:2 }}">
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                    
                    <!-- Quizzes -->
                    {% if course.quiz_count > 0 %}
                    <div class="row mt-3">
                      <div class="col-md-12">
                        <h6>Quizzes (Max: {{ quiz_max|floatformat:2 }})</h6>
                        <div class="row">
                          {% for i in "x"|rjust:course.quiz_count %}
                          <div class="col-md-4">
                            <div class="form-group">
                              <label>Quiz {{ forloop.counter }}</label>
                              <input type="number" step="0.01" class="form-control quiz-mark" 
                                     name="quiz_{{ forloop.counter }}" 
                                     max="{{ quiz_max|floatformat:2 }}">
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    {% endif %}
                    
                    <!-- Project -->
                    {% if course.project_total_marks > 0 %}
                    <div class="row mt-3">
                      <div class="col-md-12">
                        <h6>Project (Max: {{ course.project_total_marks }})</h6>
                        <div class="form-group">
                          <input type="number" step="0.01" class="form-control" 
                                 name="project" 
                                 max="{{ course.project_total_marks }}">
                        </div>
                      </div>
                    </div>
                    {% endif %}
                    
                    <!-- External -->
                    <div class="row mt-3">
                      <div class="col-md-12">
                        <h6>External Exam (Max: 100)</h6>
                        <div class="form-group">
                          <input type="number" step="0.01" class="form-control" 
                                 name="external" 
                                 max="100">
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id="saveResultsBtn">Save changes</button>
                </div>
              </div>
            </div>
          </div>
      
          <!-- Your existing scripts -->
          <script src="{% static 'js/vendor.bundle.base.js' %}"></script>
          <script src="{% static 'js/off-canvas.js' %}"></script>
          <script src="{% static 'js/hoverable-collapse.js' %}"></script>
          <script src="{% static 'js/template.js' %}"></script>
      
          <!-- Custom JavaScript for results editing -->
          <script>
            $(document).ready(function() {
              // Store max marks in JavaScript variables
              const maxMarks = {
                internal: {{ internal_max|floatformat:2 }},
                assignment: {{ assignment_max|floatformat:2 }},
                quiz: {{ quiz_max|floatformat:2 }},
                project: {{ course.project_total_marks }},
                external: 100
              };
              
              // When edit button is clicked
              $('.edit-results-btn').click(function() {
                const studentId = $(this).data('student-id');
                const courseId = $(this).data('course-id');
                
                // Set the student and course IDs in the form
                $('#studentId').val(studentId);
                $('#courseId').val(courseId);
                
                // Clear previous values
                $('#resultsForm input[type="number"]').val('');
                
                // Fetch existing results
                $.ajax({
                  url: `/api/get_student_results/${courseId}/${studentId}/`,
                  method: 'GET',
                  success: function(data) {
                    // Populate internals
                    if (data.internals) {
                      data.internals.forEach(internal => {
                        $(`input[name="internal_${internal.internal_number}"]`).val(internal.marks);
                      });
                    }
                    
                    // Populate assignments
                    if (data.assignments) {
                      data.assignments.forEach(assignment => {
                        $(`input[name="assignment_${assignment.assignment_number}"]`).val(assignment.marks);
                      });
                    }
                    
                    // Populate quizzes
                    if (data.quizzes) {
                      data.quizzes.forEach(quiz => {
                        $(`input[name="quiz_${quiz.quiz_number}"]`).val(quiz.marks);
                      });
                    }
                    
                    // Populate project
                    if (data.project) {
                      $('input[name="project"]').val(data.project.marks);
                    }
                    
                    // Populate external
                    if (data.external) {
                      $('input[name="external"]').val(data.external.marks);
                    }
                    
                    // Show the modal
                    $('#resultsModal').modal('show');
                  },
                  error: function(error) {
                    console.error('Error fetching results:', error);
                    alert('Error loading student results. Please try again.');
                  }
                });
              });
              
              // Save results
              $('#saveResultsBtn').click(function() {
                const formData = $('#resultsForm').serialize();
                
                $.ajax({
                  url: '/save_student_results/',
                  method: 'POST',
                  data: formData,
                  success: function(response) {
                    if (response.success) {
                      alert('Results saved successfully!');
                      $('#resultsModal').modal('hide');
                    } else {
                      alert('Error saving results: ' + response.error);
                    }
                  },
                  error: function(error) {
                    console.error('Error saving results:', error);
                    alert('Error saving results. Please try again.');
                  }
                });
              });
              
              // Validate marks don't exceed max
              $('.modal-body').on('input', 'input[type="number"]', function() {
                const max = parseFloat($(this).attr('max'));
                const value = parseFloat($(this).val());
                
                if (value > max) {
                  alert(`Marks cannot exceed ${max}`);
                  $(this).val(max);
                }
              });
            });
          </script>
    <!-- plugins:js -->
    <script src="{% static 'js/vendor.bundle.base.js' %}"></script>
    <!-- inject:js -->
    <script src="{% static 'js/off-canvas.js' %}"></script>
    <script src="{% static 'js/hoverable-collapse.js' %}"></script>
    <script src="{% static 'js/template.js' %}"></script>
    <!-- Custom Scripts -->
    <script>
      // Toggle sidebar
      document
        .querySelector('[data-toggle="minimize"]')
        .addEventListener("click", function () {
          document.body.classList.toggle("sidebar-icon-only");
        });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
